所谓设计**高并发**系统，就是设计一个系统，保证它**整体可用**的同时，能够**处理很高的并发用户请求**，能够承受**很大的流量冲击**。

### 高并发设计原则

![](https://img-blog.csdnimg.cn/img_convert/0172179490b9f18e16cbebb6ececed35.png)

1、无状态（**分而治之，横向扩展**）

如果设计的应用是无状态的，那么应用比较容易进行水平扩展。

如果只部署一个应用，只部署一台服务器，那抗住的流量请求是非常有限的。并且，单体的应用，有单点的风险，如果它挂了，那服务就不可用了。

因此，设计一个高并发系统，我们可以分而治之，横向扩展。也就是说，采用分布式部署的方式，部署多台服务器，把流量分流开，让每个服务器都承担一部分的并发和流量，提升整体系统的并发能力。

2、系统拆分

将一个系统拆分为多个子系统。要提高系统的吞吐，提高系统的处理并发请求的能力。除了采用**分布式部署的方式**外，还可以做**微服务拆分**，这样就可以达到分摊请求流量的目的，提高了并发能力。

- 系统维度：按照系统功能/业务拆分，比如商品系统、购物车、结算、订单系统等。
- 功能维度：对一个系统进行功能再拆分，比如，优惠券系统可以拆分为后台券创建系统、领券系统、用券系统等；
- 读写维度：根据读写比例特征进行拆分。比如，商品系统，交易的各个系统都会读取数据，读的量大于写，因此可以拆分成商品写服务、商品读服务；读服务可以考虑使用缓存提升性能；

3、服务化

随着调用方越来越多，应该考虑使用服务自动注册和发现，比如使用nacos。

4、消息队列

消息队列是用来解耦一些不需要同步调用的服务或者订阅一些自己系统关心的变化。使用消息队列可以实现服务解耦、异步处理、流量削峰。

5、缓存

缓存对于读服务来说可谓抗流量的银弹。大部分的高并发场景，都是读多写少，完全可以在数据库和缓存里都写一份，然后读的时候走缓存。

缓存分为几种：

- 浏览器端缓存
- APP客户端缓存
- CDN缓存
- Nginx缓存
- 应用层缓存

堆缓存：使用Java堆内存来存储缓存对象。可以使用Guava Cache、Ehcache 3.x、MapDB实现。

堆外缓存：即缓存数据存储在堆外内存，可以减少GC暂停时间,可以使用Ehcache 3.x、MapDB实现。

磁盘缓存：即缓存数据存储在磁盘上,可以使用Ehcache 3.x、MapDB实现。

- 分布式缓存

  可以使用 Redis，Redis 轻轻松松单机几万的并发。。

- 多级缓存

所谓多级缓存，是指在整个系统架构的不同系统层级进行数据缓存，以提升访问效率。

![](http://img.xxfxpt.top/202304111622888.png)

- 分库分表

将一个数据库拆分为多个库，多个库来扛更高的并发；然后将一个表拆分为多个表，每个表的数据量保持少一点，提高查询的性能。

- 读写分离

分库分表，可能到了最后数据库层面还是免不了抗高并发的要求，好吧，那么就将一个数据库拆分为多个库，多个库来扛更高的并发；然后将一个表拆分为多个表，每个表的数据量保持少一点，提高查询性能。

- 池化技术

在高并发的场景下，**数据库连接数**可能成为瓶颈，因为连接数是有限的。

因此，需要使用池化技术，即**数据库连接池、　HttpClient连接池、Redis 连接池**等等。使用数据库连接池，可以避免每次查询都新建连接，减少不必要的资源开销，通过复用连接池，**提高系统处理高并发请求的能力**。

同理，我们使用线程池，也能**让任务并行处理，更高效地完成任务**。

- 异步

应用中一个服务可能会调用多个依赖服务来处理业务，而这些依赖服务是可以同时调用的。如果顺序调用的话需要耗时100ms，而并发调用只需要50ms，那么可以使用异步来并发调用依赖服务，从而降低该服务的响应时间。

![](http://img.xxfxpt.top/202304121439430.png)

- CDN加速静态资源访问

  把 js、css、img等静态资源，放到CDN中，把一些页面例如商品详情页面做静态化处理，减少服务端请求。

  

![](http://img.xxfxpt.top/202304111647208.png)



### 高可用原则

1、降级

**熔断降级**是保护系统的一种手段。在分布式系统中偶尔会出现某个基础服务不可用，最终导致整个系统不可用的情况, 这种现象被称为**服务雪崩效应**。

保证设计的系统能应对**高并发场景**，那肯定要考虑**熔断降级**。

可降级的多级读服务：比如服务调用降级为只读本地缓存、只读分布式缓存、只读默认降级数据

当高并发流量来袭，在电商系统秒杀设计时保障用户能下单、能支付是核心要求，并保障数据最终一致性即可。这样就可以把一些同步调用改成异步调用，优先处理高优先级数据或特殊特征的数据，合理分配进入系统的流量，以保障系统可用。

2、限流

限流的目的是防止恶意请求流量、恶意攻击，或者防止流量超出系统峰值。

![](http://img.xxfxpt.top/202304111641141.png)