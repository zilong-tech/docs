import{$ as a,a0 as n,a1 as s,a6 as e}from"./framework-99a7911f.js";const t={},p=e(`<h2 id="什么是-nacos" tabindex="-1"><a class="header-anchor" href="#什么是-nacos" aria-hidden="true">#</a> 什么是 Nacos？</h2><p>服务（Service）是 Nacos 世界的一等公民。Nacos 支持几乎所有主流类型的“服务”的发现、配置和管理</p><p>Nacos 的关键特性包括:</p><ul><li>服务发现和服务健康监测</li><li>动态配置服务</li><li>动态 DNS 服务</li><li>服务及其元数据管理</li></ul><p>官方文档： https://nacos.io/zh-cn/docs/what-is-nacos.html</p><p><strong>主流的注册中心</strong></p><p>​ <img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.vhc4ztpjqps.png" alt=""> Nacos 生态图</p><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.1qqs3uxn3peo.png" alt=""></p><p><strong>Nacos注册中心架构</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.nzua7em5e2o.png" alt=""></p><h2 id="nacos-概念" tabindex="-1"><a class="header-anchor" href="#nacos-概念" aria-hidden="true">#</a> Nacos 概念</h2><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.217wbo1agssg.png" alt=""></p><h3 id="命名空间" tabindex="-1"><a class="header-anchor" href="#命名空间" aria-hidden="true">#</a> 命名空间</h3><p>用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。</p><h3 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h3><p>在系统开发过程中，开发者通常会将一些需要变更的参数、变量等从代码中分离出来独立管理，以独立的配置文件的形式存在。目的是让静态的系统工件或者交付物（如 WAR，JAR 包等）更好地和实际的物理运行环境进行适配。配置管理一般包含在系统部署的过程中，由系统管理员或者运维人员完成。配置变更是调整系统运行时的行为的有效手段。</p><h3 id="配置管理" tabindex="-1"><a class="header-anchor" href="#配置管理" aria-hidden="true">#</a> 配置管理</h3><p>系统配置的编辑、存储、分发、变更管理、历史版本管理、变更审计等所有与配置相关的活动。</p><h3 id="配置项" tabindex="-1"><a class="header-anchor" href="#配置项" aria-hidden="true">#</a> 配置项</h3><p>一个具体的可配置的参数与其值域，通常以 param-key=param-value 的形式存在。例如我们常配置系统的日志输出级别（logLevel=INFO|WARN|ERROR） 就是一个配置项。</p><h3 id="配置集" tabindex="-1"><a class="header-anchor" href="#配置集" aria-hidden="true">#</a> 配置集</h3><p>一组相关或者不相关的配置项的集合称为配置集。在系统中，一个配置文件通常就是一个配置集，包含了系统各个方面的配置。例如，一个配置集可能包含了数据源、线程池、日志级别等配置项。</p><h3 id="配置集-id" tabindex="-1"><a class="header-anchor" href="#配置集-id" aria-hidden="true">#</a> 配置集 ID</h3><p>Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。</p><h3 id="配置分组" tabindex="-1"><a class="header-anchor" href="#配置分组" aria-hidden="true">#</a> 配置分组</h3><p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p><h3 id="配置快照" tabindex="-1"><a class="header-anchor" href="#配置快照" aria-hidden="true">#</a> 配置快照</h3><p>Nacos 的客户端 SDK 会在本地生成配置的快照。当客户端无法连接到 Nacos Server 时，可以使用配置快照显示系统的整体容灾能力。配置快照类似于 Git 中的本地 commit，也类似于缓存，会在适当的时机更新，但是并没有缓存过期（expiration）的概念。</p><h3 id="服务" tabindex="-1"><a class="header-anchor" href="#服务" aria-hidden="true">#</a> 服务</h3><p>通过预定义接口网络访问的提供给客户端的软件功能。</p><h3 id="服务名" tabindex="-1"><a class="header-anchor" href="#服务名" aria-hidden="true">#</a> 服务名</h3><p>服务提供的标识，通过该标识可以唯一确定其指代的服务。</p><h3 id="服务注册中心" tabindex="-1"><a class="header-anchor" href="#服务注册中心" aria-hidden="true">#</a> 服务注册中心</h3><p>存储服务实例和服务负载均衡策略的数据库。</p><h3 id="服务发现" tabindex="-1"><a class="header-anchor" href="#服务发现" aria-hidden="true">#</a> 服务发现</h3><p>在计算机网络上，（通常使用服务名）对服务下的实例的地址和元数据进行探测，并以预先定义的接口提供给客户端进行查询。</p><h3 id="元信息" tabindex="-1"><a class="header-anchor" href="#元信息" aria-hidden="true">#</a> 元信息</h3><p>Nacos数据（如配置和服务）描述信息，如服务版本、权重、容灾策略、负载均衡策略、鉴权配置、各种自定义标签 (label)，从作用范围来看，分为服务级别的元信息、集群的元信息及实例的元信息。</p><h3 id="应用" tabindex="-1"><a class="header-anchor" href="#应用" aria-hidden="true">#</a> 应用</h3><p>用于标识服务提供方的服务的属性。</p><h3 id="服务分组" tabindex="-1"><a class="header-anchor" href="#服务分组" aria-hidden="true">#</a> 服务分组</h3><p>不同的服务可以归类到同一分组。</p><h3 id="虚拟集群" tabindex="-1"><a class="header-anchor" href="#虚拟集群" aria-hidden="true">#</a> 虚拟集群</h3><p>同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。</p><h3 id="实例" tabindex="-1"><a class="header-anchor" href="#实例" aria-hidden="true">#</a> 实例</h3><p>提供一个或多个服务的具有可访问网络地址（IP:Port）的进程。</p><h3 id="权重" tabindex="-1"><a class="header-anchor" href="#权重" aria-hidden="true">#</a> 权重</h3><p>实例级别的配置。权重为浮点数。权重越大，分配给该实例的流量越大。</p><h3 id="健康检查" tabindex="-1"><a class="header-anchor" href="#健康检查" aria-hidden="true">#</a> 健康检查</h3><p>以指定方式检查服务下挂载的实例 (Instance) 的健康度，从而确认该实例 (Instance) 是否能提供服务。根据检查结果，实例 (Instance) 会被判断为健康或不健康。对服务发起解析请求时，不健康的实例 (Instance) 不会返回给客户端。</p><h3 id="健康保护阈值" tabindex="-1"><a class="header-anchor" href="#健康保护阈值" aria-hidden="true">#</a> 健康保护阈值</h3><p>为了防止因过多实例 (Instance) 不健康导致流量全部流向健康实例 (Instance) ，继而造成流量压力把健康实例 (Instance) 压垮并形成雪崩效应，应将健康保护阈值定义为一个 0 到 1 之间的浮点数。当域名健康实例数 (Instance) 占总服务实例数 (Instance) 的比例小于该值时，无论实例 (Instance) 是否健康，都会将这个实例 (Instance) 返回给客户端。这样做虽然损失了一部分流量，但是保证了集群中剩余健康实例 (Instance) 能正常工作。</p><h2 id="核心功能" tabindex="-1"><a class="header-anchor" href="#核心功能" aria-hidden="true">#</a> <strong>核心功能</strong></h2><p><strong>服务注册</strong>：Nacos Client会通过发送REST请求的方式向Nacos Server注册自己的服务，提供自身的元数据，比如ip地址、端口等信息。Nacos Server接收到注册请求后，就会把这些元数据信息存储在一个双层的内存Map中。</p><p><strong>服务心跳</strong>：在服务注册后，Nacos Client会维护一个定时心跳来持续通知Nacos Server，说明服务一直处于可用状态，防止被剔除。默认5s发送一次心跳。</p><p><strong>服务同步</strong>：Nacos Server集群之间会互相同步服务实例，用来保证服务信息的一致性。 leader raft</p><p><strong>服务发现</strong>：服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个REST请求给Nacos Server，获取上面注册的服务清单，并且缓存在Nacos Client本地，同时会在Nacos Client本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存</p><p><strong>服务健康检查</strong>：Nacos Server会开启一个定时任务用来检查注册服务实例的健康情况，对于超过15s没有收到客户端心跳的实例会将它的healthy属性置为false(客户端服务发现时不会发现)，如果某个实例超过30秒没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)</p><h2 id="数据模型" tabindex="-1"><a class="header-anchor" href="#数据模型" aria-hidden="true">#</a> 数据模型</h2><p>Nacos 数据模型 Key 由三元组唯一确定, Namespace默认是空串，公共命名空间（public），分组默认是 DEFAULT_GROUP。</p><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.2eug1g2s7tno.png" alt=""></p><h2 id="服务领域模型" tabindex="-1"><a class="header-anchor" href="#服务领域模型" aria-hidden="true">#</a> 服务领域模型</h2><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.7ef01oars980.png" alt=""></p><h2 id="快速使用" tabindex="-1"><a class="header-anchor" href="#快速使用" aria-hidden="true">#</a> 快速使用</h2><p>官方文档：https://nacos.io/zh-cn/docs/quick-start.html</p><p><strong>下载安装包</strong></p><p>下载地址：https://github.com/alibaba/Nacos/releases</p><h4 id="单机部署" tabindex="-1"><a class="header-anchor" href="#单机部署" aria-hidden="true">#</a> <strong>单机部署</strong></h4><p>启动命令(standalone代表着单机模式运行，非集群模式):</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sh</span> startup.sh <span class="token parameter variable">-m</span> standalone
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>访问nocas的管理端：http://127.0.0.1:8848/nacos ，默认的用户名密码是 nocas/nocas</p><p>​ <img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.7g9d6djy6680.png" alt=""></p><h4 id="集群方式部署" tabindex="-1"><a class="header-anchor" href="#集群方式部署" aria-hidden="true">#</a> 集群方式部署</h4><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.68imq1twf680.png" alt=""></p><p>部署方式参考：https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</p><h4 id="搭建nacos客户端" tabindex="-1"><a class="header-anchor" href="#搭建nacos客户端" aria-hidden="true">#</a> 搭建nacos客户端</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependencyManagement<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>

        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token class-name">Hoxton</span><span class="token punctuation">.</span><span class="token constant">SR8</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>type<span class="token punctuation">&gt;</span></span>pom<span class="token operator">&lt;</span><span class="token operator">/</span>type<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span><span class="token keyword">import</span><span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>alibaba<span class="token operator">-</span>dependencies<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.2</span><span class="token number">.5</span><span class="token punctuation">.</span><span class="token constant">RELEASE</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>type<span class="token punctuation">&gt;</span></span>pom<span class="token operator">&lt;</span><span class="token operator">/</span>type<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span><span class="token keyword">import</span><span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> nacos服务注册与发现 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependencyManagement<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>application.yml配置：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user  <span class="token comment">#微服务名称</span>

  <span class="token comment">#配置nacos注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.253.128<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 80a98d11<span class="token punctuation">-</span>492c<span class="token punctuation">-</span>4008<span class="token punctuation">-</span>85aa<span class="token punctuation">-</span>32d889e9b0d0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>更多配置：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery</p><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.1l7l658efzi8.png" alt=""></p><p>启动服务后，打开管理页面：</p><p><img src="https://cdn.jsdelivr.net/gh/zilong-tech/images@master/20230202/image.421spfacsoi0.png" alt=""></p><h2 id="nacos上服务注册ip不对导致访问服务未找到或者接口超时的问题" tabindex="-1"><a class="header-anchor" href="#nacos上服务注册ip不对导致访问服务未找到或者接口超时的问题" aria-hidden="true">#</a> nacos上服务注册Ip不对导致访问服务未找到或者接口超时的问题</h2><p>在nacos的配置文件中添加配置项指定优先注册到nacos中的外网ip的前缀</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>

  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
      <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> 192.168.173
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,86),o=[p];function c(r,i){return n(),s("div",null,o)}const d=a(t,[["render",c],["__file","spring cloud（二）注册中心.html.vue"]]);export{d as default};
